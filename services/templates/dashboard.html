{% extends "base.html" %}
{% block content %}

<div class="container-fluid pt-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h2 class="fw-bold text-white mb-0">Welcome back, <span style="color: var(--accent-blue);">{{ user.username }}</span></h2>
            <p class="text-secondary">Your central hub for university services and schedules.</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="notice-ticker-container shadow-sm">
                <div class="ticker-label"><i class="bi bi-broadcast me-2"></i>LATEST NOTICES</div>
                <div class="ticker-content">
                    <marquee behavior="scroll" direction="left" onmouseover="this.stop();" onmouseout="this.start();">
                        {% for notice in notices %}
                            <span class="ticker-item">
                                <i class="bi bi-megaphone-fill text-warning"></i> 
                                <strong>{{ notice.club.club_name }}:</strong> {{ notice.event_name }} ({{ notice.event_date|date:"M d" }})
                            </span>
                        {% empty %}
                            <span class="ticker-item">System Online: All academic and transit services are operational.</span>
                        {% endfor %}
                    </marquee>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card h-100 service-card">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fw-bold text-white"><i class="bi bi-egg-fried me-2 text-info"></i>Cafeteria</h5>
                    <p class="card-text text-secondary small">Daily menus and meal subscription management.</p>
                    <div class="mt-auto pt-3">
                        <a href="{% url 'cafeteria_main' %}" class="btn btn-sm btn-outline-info">View Menu</a>
                        <a href="{% url 'meal_booking' %}" class="btn btn-sm btn-info ms-1">Book Now</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 service-card transport-card">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fw-bold text-white"><i class="bi bi-bus-front me-2 text-warning"></i>Transport</h5>
                    <p class="card-text text-secondary small">Real-time bus tracking and schedule updates.</p>
                    <a href="{% url 'bus_schedules' %}" class="btn btn-sm btn-outline-warning mt-auto">Check Routes</a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 service-card academics-card">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fw-bold text-white"><i class="bi bi-calendar3 me-2 text-danger"></i>Academics</h5>
                    <p class="card-text text-secondary small">Class routines and personalized academic calendar.</p>
                    <a href="{% url 'class_schedules' %}" class="btn btn-sm btn-outline-danger mt-auto">My Schedule</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-12 col-md-6">
            <div class="card h-100 shadow-lg transition-card" 
                 style="background: var(--card-bg); border: 1px solid {% if user.studentwallet.balance < 50 %}#ff4b2b{% else %}#00ff88{% endif %};">
                <div class="card-body d-flex flex-column flex-sm-row align-items-sm-center">
                    <div class="flex-grow-1">
                        <h6 class="fw-bold" style="color: {% if user.studentwallet.balance < 50 %}#ff4b2b{% else %}#00ff88{% endif %};">
                            <i class="bi bi-wallet2 me-2"></i>Campus Wallet
                        </h6>
                        <div class="h2 fw-bold text-white mb-0">৳{{ user.studentwallet.balance }}</div>
                        <p class="small mb-0 {% if user.studentwallet.balance < 50 %}text-danger fw-bold animate-pulse{% else %}text-white{% endif %}">
                            {% if user.studentwallet.balance < 50 %}
                                <i class="bi bi-exclamation-triangle-fill me-1"></i> Low Balance: Please Top-up
                            {% else %}
                                Status: Fully Encrypted & Secure
                            {% endif %}
                        </p>
                    </div>
                    <div class="mt-3 mt-sm-0 ms-sm-3 d-grid gap-2">
                        <a href="{% url 'initiate_payment' %}" class="btn {% if user.studentwallet.balance < 50 %}btn-danger{% else %}btn-outline-success{% endif %} px-4">Add Credit</a>
                        <a href="{% url 'transaction_history' %}" class="btn btn-sm btn-outline-secondary">History</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="card h-100 shadow-lg" style="background: var(--card-bg); border: 1px solid var(--accent-blue);">
                <div class="card-body d-flex flex-column flex-sm-row align-items-sm-center">
                    <div class="flex-grow-1">
                        <h6 class="text-info fw-bold"><i class="bi bi-graph-up-arrow me-2"></i>Weekly Meal Budget</h6>
                        <div class="h2 fw-bold text-white mb-0">৳{{ weekly_total }}</div>
                        
                        <div class="mt-2 p-2 rounded bg-dark border border-secondary d-inline-block">
                            <small class="text-secondary d-block" style="font-size: 0.65rem;">BOOKING ENDS IN:</small>
                            <span id="meal-timer" class="text-warning fw-bold" style="font-size: 0.9rem;">00:00:00</span>
                        </div>
                    </div>
                    
                    <div class="mt-3 mt-sm-0 ms-sm-3 text-sm-end" style="min-width: 180px;">
                        <div class="d-grid gap-2">
                            <a href="{% url 'cafeteria_main' %}" class="btn btn-neon btn-sm py-1">Analytics</a>
                            <form action="{% url 'download_meal_summary' %}" method="GET">
                                <div class="d-grid gap-1">
                                    <select name="month" class="form-select form-select-sm bg-dark text-white border-info" style="font-size: 0.7rem;">
                                        <option value="1">January</option>
                                        <option value="2" selected>February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                    </select>
                                    <button type="submit" class="btn btn-sm btn-outline-light py-1" style="font-size: 0.7rem;">
                                        <i class="bi bi-file-earmark-pdf"></i> Export PDF
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* CSS Polished for Mobile and Linting */
    .notice-ticker-container {
        display: flex;
        background-color: var(--card-bg);
        border: 1px solid rgba(0, 210, 255, 0.3);
        border-radius: 8px;
        overflow: hidden;
        height: 44px;
        align-items: center;
    }
    .ticker-label {
        background-color: var(--accent-blue);
        color: #000000;
        padding: 0 20px;
        font-weight: 800;
        font-size: 0.75rem;
        height: 100%;
        display: flex;
        align-items: center;
        white-space: nowrap;
    }
    .ticker-content { width: 100%; color: var(--text-main); font-size: 0.9rem; }
    .ticker-item { margin-right: 60px; font-weight: 500; }
    
    .service-card {
        background-color: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-top: 4px solid var(--accent-blue);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .transport-card { border-top-color: #f9d423; }
    .academics-card { border-top-color: #ff4b2b; }

    .service-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    .btn-neon {
        border: 1px solid var(--accent-blue);
        color: var(--accent-blue);
        background-color: transparent;
        transition: 0.3s;
    }
    .btn-neon:hover {
        background-color: var(--accent-blue);
        color: #000000;
        box-shadow: var(--neon-glow);
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    .animate-pulse { animation: pulse 2s infinite; }
</style>

<script>
    function updateMealTimer() {
        const now = new Date();
        const deadline = new Date();
        
        // Deadline set to 10:00 PM
        deadline.setHours(22, 0, 0, 0);

        if (now > deadline) {
            deadline.setDate(deadline.getDate() + 1);
        }

        const diff = deadline - now;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        const hDisplay = hours < 10 ? "0" + hours : hours;
        const mDisplay = minutes < 10 ? "0" + minutes : minutes;
        const sDisplay = seconds < 10 ? "0" + seconds : seconds;

        const timerElement = document.getElementById("meal-timer");
        if (timerElement) {
            timerElement.innerHTML = `${hDisplay}:${mDisplay}:${sDisplay}`;
        }
    }

    setInterval(updateMealTimer, 1000);
    updateMealTimer();
</script>

{% endblock %}